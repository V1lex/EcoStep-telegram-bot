# Руководство для разработчиков EcoStep

Этот документ описывает рабочий процесс команды, технические требования и чек-листы, которые нужно проходить перед merge. Основной README рассказывает о продукте, здесь же — правила поддержки кода.

## Рабочий процесс
- **Главная ветка `main` всегда деплойна.** Любые изменения в мастер попадают на сервер Telegram-бота, поэтому работаем через feature-ветки: `feature/<issue-id>-short-title`, `fix/<issue>`, `docs/<topic>`.
- **Коммиты атомарны.** Один коммит — одна логическая правка. Сообщения в стиле `fix: handle challenge decline errors` помогают отслеживать историю.
- **Pull Request = документация.** Описываем, какие проблемы решает PR, прикладываем скриншоты mini app или логи бота, если затронут UX.
- **Не забываем про задачи.** Упоминаем номер тикета GitHub/GitLab в описании PR и первом коммите: `Closes #42`.

## Настройка окружения
1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```
2. Скопируйте `.env` и заполните хотя бы `BOT_TOKEN`. Для локальной разработки можно создать тестового бота и админа:
   ```ini
   BOT_TOKEN=123:ABC
   ADMIN_IDS=123456789
   ADMIN_PANEL_PASSWORD=localpass
   ADMIN_WEBAPP_URL=https://127.0.0.1:8000  # mini app открывается только по HTTPS!
   ```
3. **Не коммитим `.env`, базы и токены.** Добавляйте новые секреты в `.env.example`, если потребуется.

## Гайдлайны по коду
- Пишем асинхронно: никакого блокирующего I/O в `handlers/` — используйте `asyncio.to_thread` или фоновые задачи в `tasks/`.
- Каждая новая фича должна быть оформлена отдельным `Router` или под-роутером aiogram, чтобы их можно было включать/отключать в `run.py`.
- Минимизируем прямые SQL-запросы из обработчиков. Если нужна новая операция, добавляйте функцию в `database.py` и покрывайте юнит-тестом.
- Каждый публичный хелпер описываем короткой docstring’ой и добавляем аннотации типов — это облегчает работу FastAPI и Pydantic-схем.
- Любые новые команды в боте нужно регистрировать в `utils/bot_commands.py`.

## Работа с БД
- В проекте используется SQLite (`ecostep.db`). Для миграций применяем подход «ленивого ALTER» внутри `init_db()` — проверяем схему через `PRAGMA table_info`.
- Если добавляем новую таблицу или поле, обязательно:
  1. Обновите `init_db()`.
  2. Продумайте, как тесты будут создавать/очищать данные (`tests/test_database.py`).
  3. Опишите изменения в `docs/` (например, `docs/verification_rules.md`) и в PR.

## Админская mini app
- Backend находится в `admin_webapp/backend`. Новые ручки FastAPI оформляем через Pydantic-схемы в `schemas.py` и подключаем к `APIRouter` в `main.py`.
- Если нужно обращаться к Telegram API, используйте уже создаваемый объект `bot` из `create_bot.py` и учитывайте rate limit.
- UI (`admin_webapp/index.html`, `app.js`, `styles.css`) — обычная SPA. Любые изменения должны корректно работать при открытии через `tg://resolve?domain=<bot>&startapp=<payload>`.

## Тестирование
- **Юнит**: `pytest tests/test_database.py` — обязательно перед PR, даже если не трогали БД. Если добавляете новую бизнес-логику, пишите отдельные тесты.
- **Интеграция**: по возможности прикладывайте скриншоты диалога с ботом или запросы к FastAPI (например, через Thunder Client/HTTPie).
- **Линтеры**: пока не подключены. При необходимости запускайте `python -m compileall .` для поиска синтаксических ошибок.

## Чек-лист перед merge
- [ ] PR описывает проблему и решение.
- [ ] Все зависимости добавлены в `requirements.txt` / `admin_webapp` при необходимости.
- [ ] Настройки для новой функциональности задокументированы (README либо docs/).
- [ ] Добавлены тесты или обновлены существующие.
- [ ] Проверено локально: бот запускается (`python run.py`), mini app при необходимости отвечает (`uvicorn ...`).
- [ ] Секреты не попали в историю.

С вопросами в ЧАТ!
